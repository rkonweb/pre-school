// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma_v2"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model School {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  address      String?
  city         String?
  state        String?
  zip          String?
  country      String?
  latitude     String?
  longitude    String?
  phone        String?
  email        String?
  website      String?
  motto        String?
  foundingYear String?
  logo         String?
  brandColor   String?       @default("#2563eb")
  
  // Social Media
  facebook     String?
  twitter      String?
  linkedin     String?
  instagram    String?
  youtube      String?

  // Configuration
  currency     String?       @default("USD")
  timezone     String?       @default("UTC-5 (EST)")
  dateFormat   String?       @default("MM/DD/YYYY")
  googleMapsApiKey String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  users         User[]
  students      Student[]
  classrooms    Classroom[]
  admissions    Admission[]
  leavePolicies LeavePolicy[]
  subscription  Subscription?
}

model Admission {
  id            String   @id @default(cuid())
  studentName   String
  studentAge    Int?
  studentGender String?
  dateOfBirth   DateTime?
  
  parentName    String
  parentEmail   String?
  parentPhone   String?
  secondaryPhone String?
  relationship  String?   // Father, Mother, Guardian, etc.

  // Father Details
  fatherName    String?
  fatherPhone   String?
  fatherEmail   String?
  fatherOccupation String?

  // Mother Details
  motherName    String?
  motherPhone   String?
  motherEmail   String?
  motherOccupation String?

  address       String?
  city          String?
  state         String?
  country       String?
  zip           String?
  
  officialStatus String?  @default("INTERESTED") // INTERESTED, NOT_INTERESTED, FAKE, DUPLICATE, etc.
  stage          String   @default("INQUIRY") // INQUIRY, APPLICATION, INTERVIEW, ENROLLED
  priority      String   @default("MEDIUM")  // LOW, MEDIUM, HIGH
  enrolledGrade String?
  source        String?   // Social Media, Referral, Walk-in, etc.
  notes         String?
  
  // Comprehensive Admission Data
  bloodGroup           String?
  medicalConditions    String?
  allergies            String?
  emergencyContactName String?
  emergencyContactPhone String?
  previousSchool       String?
  documents            String?   // Store as JSON string { "birth_cert": "url", "id_proof": "url" }
  accessToken          String?   @unique // For public parent link
  admissionFormStep    Int       @default(0) // Track completion progress
  
  dateReceived  DateTime @default(now())
  
  schoolId      String
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model User {
  id          String    @id @default(cuid())
  mobile      String    @unique
  email       String?
  firstName   String?
  lastName    String?
  designation String?
  department  String?
  joiningDate DateTime?
  status      String    @default("ACTIVE") // ACTIVE, INACTIVE, LEAVE
  avatar      String?
  address     String?
  role        String    @default("ADMIN") // ADMIN, STAFF, PARENT
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  schoolId    String?
  school      School?   @relation(fields: [schoolId], references: [id])
  
  managedClassrooms Classroom[] @relation("ClassTeacher")

  // Documents
  documents   String?   // JSON string { "cv": "url", "idProof": "url", "certificates": ["url1"] }

  // Comprehensive Staff Data
  gender               String?
  dateOfBirth          DateTime?
  bloodGroup           String?
  
  // Emergency Contact
  emergencyContactName String?
  emergencyContactPhone String?
  emergencyContactRelation String?

  // Extended Address
  addressCity          String?
  addressState         String?
  addressZip           String?
  addressCountry       String?

  // Professional Stats
  qualifications       String?
  experience           String? 
  employmentType       String?   // FULL_TIME, PART_TIME, CONTRACT
  
  // Banking Details
  bankName             String?
  bankAccountNo        String?
  bankIfsc             String?

  // Socials
  facebook             String?
  linkedin             String?
  twitter              String?
  instagram            String?

  staffAttendance      StaffAttendance[]
  leaveRequests       LeaveRequest[]
  salaryRevisions     SalaryRevision[]
  leaveBalances       LeaveBalance[]
}

model LeavePolicy {
  id              String      @id @default(cuid())
  name            String      // e.g., "Standard Staff Policy 2024"
  description     String?
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isDefault       Boolean     @default(false)
  
  schoolId        String
  school          School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Punctuality Rules
  lateComingGrace   Int       @default(15) // Minutes grace per day
  lateComingMax     Int       @default(60) // Total allowed late minutes per month
  earlyLeavingGrace Int       @default(15) // Minutes early allowed per day
  earlyLeavingMax   Int       @default(60) // Total allowed early minutes per month
  
  // Permission Rules (Short breaks)
  permissionAllowed Boolean   @default(true)
  permissionMaxMins Int       @default(120) // Total permission minutes per month
  permissionMaxOccur Int      @default(2)   // Max occurrences per month
  
  leaveTypes      LeaveType[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model LeaveType {
  id                String      @id @default(cuid())
  name              String      // e.g., "Casual Leave", "Sick Leave"
  code              String      // e.g., "CL", "SL"
  totalDays         Float       // Annual limit
  canCarryForward   Boolean     @default(false)
  maxCarryForward   Float       @default(0)
  isPaid            Boolean     @default(true)
  allowHalfDay      Boolean     @default(true)
  minNoticePeriod   Int         @default(0) // In days
  
  // Specific Conditions
  requiresApproval  Boolean     @default(true)
  gender            String?     // MALE, FEMALE, ALL
  
  policyId          String
  policy            LeavePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  
  leaveBalances     LeaveBalance[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model LeaveBalance {
  id          String      @id @default(cuid())
  total       Float       // Entitled
  used        Float       @default(0)
  pending     Float       @default(0)
  remaining   Float
  
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  leaveTypeId String
  leaveType   LeaveType   @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  
  year        Int         // Tracking per year
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([userId, leaveTypeId, year])
}

model SalaryRevision {
  id              String   @id @default(cuid())
  amount          Float    // Total CTC (Gross)
  currency        String   @default("INR")
  revisionDate    DateTime @default(now())
  effectiveDate   DateTime
  reason          String?  // e.g., "Annual Revision", "Promotion", "Joining"
  type            String   @default("INCREMENT") // INCREMENT, DECREMENT, INITIAL
  
  // Breakdown
  basic           Float    @default(0)
  hra             Float    @default(0)
  allowance       Float    @default(0)
  
  // Deductions
  tax             Float    @default(0)
  pf              Float    @default(0)
  insurance       Float    @default(0)
  otherDeductions Float    @default(0)
  
  netSalary       Float    @default(0)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Classroom {
  id        String    @id @default(cuid())
  name      String
  schoolId  String
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  teacherId String?
  teacher   User?     @relation("ClassTeacher", fields: [teacherId], references: [id])
  
  students  Student[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Student {
  id          String    @id @default(cuid())
  firstName   String
  lastName    String
  avatar      String?
  age         Int?
  gender      String?
  dateOfBirth DateTime?
  grade       String?
  status      String    @default("ACTIVE") // ACTIVE, INACTIVE, ABSENT
  
  // Parents
  parentName   String?
  parentMobile String?
  parentEmail  String?
  
  // Comprehensive Data
  bloodGroup           String?
  medicalConditions    String?
  allergies            String?
  emergencyContactName String?
  emergencyContactPhone String?
  
  classroomId String?
  classroom   Classroom? @relation(fields: [classroomId], references: [id])
  
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  attendance  Attendance[]
  reports     ReportCard[]
  fees        Fee[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Fee {
  id          String   @id @default(cuid())
  title       String   // e.g. "Term 1 Tuition"
  amount      Float
  dueDate     DateTime
  status      String   @default("PENDING") // PENDING, PAID, OVERDUE, PARTIAL
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  payments    FeePayment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FeePayment {
  id          String   @id @default(cuid())
  amount      Float
  date        DateTime @default(now())
  method      String   // CASH, CARD, TRANSFER
  reference   String?  // Transaction ID etc
  
  feeId       String
  fee         Fee      @relation(fields: [feeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Attendance {
  id        String   @id @default(cuid())
  date      DateTime
  status    String   // PRESENT, ABSENT, LATE, EXCUSED
  notes     String?
  
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date])
}

model ReportCard {
  id          String   @id @default(cuid())
  term        String   // e.g. "Term 1 2024"
  marks       String   // JSON string of subjects and grades
  comments    String?
  published   Boolean  @default(false)
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Otp {
  id        String    @id @default(cuid())
  mobile    String
  code      String
  expiresAt DateTime
  verified  Boolean   @default(false)
  createdAt DateTime  @default(now())
}

model Subscription {
  id        String    @id @default(cuid())
  planId    String
  status    String    @default("TRIAL")
  startDate DateTime  @default(now())
  endDate   DateTime?

  schoolId  String    @unique
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model MasterData {
  id        String   @id @default(cuid())
  type      String   // GRADE, COUNTRY, STATE, CITY, etc.
  name      String
  code      String?  
  
  parentId  String?
  parent    MasterData? @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MasterData[] @relation("Hierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, name, parentId])
}

model StaffAttendance {
  id           String   @id @default(cuid())
  date         DateTime
  status       String   @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY
  notes        String?
  totalHours   Float?   @default(0)
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  punches      StaffPunch[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, date])
}

model StaffPunch {
  id           String   @id @default(cuid())
  type         String   // IN, OUT
  timestamp    DateTime @default(now())
  
  attendanceId String
  attendance   StaffAttendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id           String   @id @default(cuid())
  startDate    DateTime
  endDate      DateTime
  type         String   // PLANNED, UNPLANNED, SICK, CASUAL, etc.
  reason       String?  
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
