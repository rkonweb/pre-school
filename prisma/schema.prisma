generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  address             String?
  email               String?              @unique
  phone               String?              @unique
  brandColor          String?              @default("#2563eb")
  city                String?
  country             String?
  currency            String?              @default("USD")
  dateFormat          String?              @default("MM/DD/YYYY")
  facebook            String?
  foundingYear        String?
  instagram           String?
  latitude            String?
  linkedin            String?
  logo                String?
  printableLogo       String?
  longitude           String?
  motto               String?
  state               String?
  timezone            String?              @default("UTC")
  twitter             String?
  website             String?
  youtube             String?
  zip                 String?
  googleMapsApiKey    String?
  academicYearEnd     DateTime?
  academicYearStart   DateTime?
  academicYearStartMonth Int?                @default(4)
  primaryColor        String?              @default("#2563eb")
  schoolTimings       String?              @default("9:00 AM - 3:00 PM")
  secondaryColor      String?
  workingDays         String?
  timetableConfig     String?              @default("{}")
  customDomain        String?              @unique
  modulesConfig       String?              @default("[]")
  addonsConfig        String?              @default("[]")
  integrationsConfig  String?              @default("{}")
  admissions          Admission[]
  biometricLogs       BiometricLog[]
  classrooms          Classroom[]
  diaryEntries        DiaryEntry[]
  exams               Exam[]
  feeStructures       FeeStructure[]
  leavePolicies       LeavePolicy[]
  libraryBooks        LibraryBook[]
  librarySettings     LibrarySettings?
  libraryTransactions LibraryTransaction[]
  payrolls            Payroll[]
  payrollSettings     PayrollSettings?
  roles               Role[]
  students            Student[]
  subscription        Subscription?
  transportDrivers    TransportDriver[]
  transportRoutes     TransportRoute[]
  transportVehicles   TransportVehicle[]
  users               User[]
  marketingDesigns    SchoolMarketingDesign[]
  academicYears       AcademicYear[]
  branches            Branch[]
  leads               Lead[]
  whatsappTemplates   WhatsAppTemplate[]
  leadAutomationRules LeadAutomationRule[]
  aiSettings          AISettings?
}

model AcademicYear {
  id        String   @id @default(cuid())
  name      String   // e.g. "2023-2024"
  startDate DateTime
  endDate   DateTime
  status    String   @default("ACTIVE") // ACTIVE, ARCHIVED
  isCurrent Boolean  @default(false)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  exams           Exam[]
  attendance      Attendance[]
  fees            Fee[]
  activityRecords StudentActivityRecord[]
  healthRecords   StudentHealthRecord[]
  reportCards     ReportCard[]
  homework        Homework[]
  diaryEntries    DiaryEntry[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Admission {
  id                    String    @id @default(cuid())
  studentName           String
  studentAge            Int?
  studentGender         String?
  dateOfBirth           DateTime?
  parentName            String
  parentEmail           String?
  parentPhone           String?
  secondaryPhone        String?
  relationship          String?
  fatherName            String?
  fatherPhone           String?
  fatherEmail           String?
  fatherOccupation      String?
  motherName            String?
  motherPhone           String?
  motherEmail           String?
  motherOccupation      String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  zip                   String?
  officialStatus        String?   @default("INTERESTED")
  stage                 String    @default("INQUIRY")
  priority              String    @default("MEDIUM")
  enrolledGrade         String?
  source                String?
  notes                 String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  previousSchool        String?
  documents             String?
  accessToken           String?   @unique
  admissionFormStep     Int       @default(0)
  dateReceived          DateTime  @default(now())
  schoolId              String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  school                School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  marketingStatus       String    @default("NEW") // NEW, CONTACTED, INTERESTED, etc.
  score                 Int       @default(50)
  counsellorId          String?
  counsellor            User?     @relation("AdmissionCounsellor", fields: [counsellorId], references: [id])
  
  // Detailed CRM Fields
  lastMeaningfulActionAt DateTime?
  tourStatus             String    @default("NONE") // NONE, SCHEDULED, COMPLETED
  feeConcernLevel        String    @default("NONE") // NONE, MILD, STRONG
  distanceConcern        Boolean   @default(false)
  timingConcern          Boolean   @default(false)
  programFit             String    @default("GOOD") // GOOD, CLOSE, BAD
  seatAvailability       String    @default("AVAILABLE") // AVAILABLE, WAITLIST
  
  interactions          LeadInteraction[]
  followUps             FollowUp[]
  automationPaused      Boolean   @default(false)

  @@index([schoolId])
  @@index([stage])
  @@index([parentPhone])
  @@index([parentEmail])
}

model User {
  id                       String                @id @default(cuid())
  mobile                   String                @unique
  email                    String?               @unique
  firstName                String?
  lastName                 String?
  designation              String?
  department               String?
  joiningDate              DateTime?
  status                   String                @default("ACTIVE")
  avatar                   String?
  address                  String?
  role                     String                @default("ADMIN")
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  schoolId                 String?
  documents                String?
  gender                   String?
  dateOfBirth              DateTime?
  bloodGroup               String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  addressCity              String?
  addressState             String?
  addressZip               String?
  addressCountry           String?
  qualifications           String?
  experience               String?
  employmentType           String?
  subjects                 String?
  bankName                 String?
  bankAccountNo            String?
  bankIfsc                 String?
  facebook                 String?
  linkedin                 String?
  twitter                  String?
  instagram                String?
  customRoleId             String?
  biometricId              String?               @unique
  BlogPost                 BlogPost[]
  classAccesses            ClassAccess[]
  managedClassrooms        Classroom[]           @relation("ClassTeacher")
  diaryEntries             DiaryEntry[]          @relation("DiaryAuthor")
  createdExams             Exam[]
  leaveBalances            LeaveBalance[]
  leaveRequests            LeaveRequest[]
  libraryTransactions      LibraryTransaction[]
  payslips                 Payslip[]
  salaryRevisions          SalaryRevision[]
  managedStaff             StaffAccess[]         @relation("ManagerMapping")
  branchId                 String?
  branch                   Branch?               @relation(fields: [branchId], references: [id])
  managedLeads             Lead[]                @relation("LeadCounsellor")
  managedAdmissions        Admission[]           @relation("AdmissionCounsellor")
  followUps                FollowUp[]
  leadInteractions         LeadInteraction[]
  managedBy                StaffAccess[]         @relation("StaffMapping")
  staffAttendance          StaffAttendance[]
  recordedHealth           StudentHealthRecord[]
  transportDriver          TransportDriver?
  school                   School?               @relation(fields: [schoolId], references: [id])
  customRole               Role?                 @relation(fields: [customRoleId], references: [id])

  @@index([role])
  @@index([status])
}

model LeavePolicy {
  id                  String      @id @default(cuid())
  name                String
  description         String?
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  isDefault           Boolean     @default(false)
  schoolId            String
  lateComingGrace     Int         @default(15)
  lateComingMax       Int         @default(60)
  earlyLeavingGrace   Int         @default(15)
  earlyLeavingMax     Int         @default(60)
  minFullDayHours     Float       @default(8.0)
  minHalfDayHours     Float       @default(4.0)
  maxDailyPunchEvents Int         @default(10)
  minPunchGapMins     Int         @default(0)
  roleId              String?
  permissionAllowed   Boolean     @default(true)
  permissionMaxMins   Int         @default(120)
  permissionMaxOccur  Int         @default(2)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  school              School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  role                Role?       @relation(fields: [roleId], references: [id])
  leaveTypes          LeaveType[]
}

model LeaveType {
  id               String         @id @default(cuid())
  name             String
  code             String
  totalDays        Float
  canCarryForward  Boolean        @default(false)
  maxCarryForward  Float          @default(0)
  isPaid           Boolean        @default(true)
  allowHalfDay     Boolean        @default(true)
  minNoticePeriod  Int            @default(0)
  requiresApproval Boolean        @default(true)
  gender           String?
  policyId         String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  leaveBalances    LeaveBalance[]
  policy           LeavePolicy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
}

model LeaveBalance {
  id          String    @id @default(cuid())
  total       Float
  used        Float     @default(0)
  pending     Float     @default(0)
  remaining   Float
  userId      String
  leaveTypeId String
  year        Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([userId, leaveTypeId, year])
}

model SalaryRevision {
  id               String   @id @default(cuid())
  amount           Float
  currency         String   @default("INR")
  revisionDate     DateTime @default(now())
  effectiveDate    DateTime
  reason           String?
  type             String   @default("INCREMENT")
  basic            Float    @default(0)
  hra              Float    @default(0)
  allowance        Float    @default(0)
  tax              Float    @default(0)
  pf               Float    @default(0)
  insurance        Float    @default(0)
  otherDeductions  String?
  customAdditions  String?
  customDeductions String?
  netSalary        Float    @default(0)
  userId           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Classroom {
  id           String        @id @default(cuid())
  name         String
  schoolId     String
  teacherId    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  capacity     Int?          @default(30)
  roomNumber   String?
  timetable    String?       @default("[]")
  accesses     ClassAccess[]
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher      User?         @relation("ClassTeacher", fields: [teacherId], references: [id])
  diaryEntries DiaryEntry[]
  students     Student[] @relation("CurrentClass")
  promotedStudents Student[] @relation("PromotedClass")

  @@index([schoolId])
}

model Student {
  id                    String                   @id @default(cuid())
  firstName             String
  lastName              String
  avatar                String?
  age                   Int?
  gender                String?
  dateOfBirth           DateTime?
  grade                 String?
  status                String                   @default("ACTIVE")
  parentName            String?
  parentMobile          String?
  parentEmail           String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  classroomId           String?
  promotedToClassroomId String?
  promotedToGrade       String?
  schoolId              String
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  admissionNumber       String?
  joiningDate           DateTime?
  leavingDate           DateTime?
  attendance            Attendance[]
  conversations         Conversation[]
  diaryRecipients       DiaryRecipient[]
  examResults           ExamResult[]
  fees                  Fee[]
  libraryTransactions   LibraryTransaction[]
  reports               ReportCard[]
  classroom             Classroom?               @relation("CurrentClass", fields: [classroomId], references: [id])
  promotedToClassroom    Classroom?               @relation("PromotedClass", fields: [promotedToClassroomId], references: [id])
  school                School                   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  activityRecords       StudentActivityRecord[]
  healthRecords         StudentHealthRecord[]
  transportProfile      StudentTransportProfile?

  @@index([schoolId])
  @@index([classroomId])
  @@index([promotedToClassroomId])
  @@index([status])
}

model Fee {
  id          String       @id @default(cuid())
  title       String
  amount      Float
  dueDate     DateTime
  status      String       @default("PENDING")
  studentId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  description String?
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments    FeePayment[]

  @@index([academicYearId])
}

model FeePayment {
  id        String   @id @default(cuid())
  amount    Float
  date      DateTime @default(now())
  method    String
  reference String?
  feeId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  fee       Fee      @relation(fields: [feeId], references: [id], onDelete: Cascade)
}

model Attendance {
  id        String   @id @default(cuid())
  date      DateTime
  status    String
  notes     String?
  studentId String
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([academicYearId])
}

model ReportCard {
  id        String   @id @default(cuid())
  term      String
  marks     String
  comments  String?
  published Boolean  @default(false)
  studentId String
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([academicYearId])
}

model Otp {
  id        String   @id @default(cuid())
  mobile    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model SubscriptionPlan {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  description     String?
  price           Float          @default(0)
  currency        String         @default("INR")
  billingPeriod   String         @default("monthly")
  features        String         @default("[]")
  maxStudents     Int            @default(0)
  maxStaff        Int            @default(0)
  maxStorageGB    Int            @default(0)
  tier            String         @default("free")
  supportLevel    String         @default("community")
  isActive        Boolean        @default(true)
  isPopular       Boolean        @default(false)
  includedModules String         @default("[]")
  sortOrder       Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  subscriptions   Subscription[]
}

model Subscription {
  id        String           @id @default(cuid())
  status    String           @default("TRIAL")
  startDate DateTime         @default(now())
  endDate   DateTime?
  planId    String
  schoolId  String           @unique
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model MasterData {
  id        String       @id @default(cuid())
  type      String
  name      String
  code      String?
  parentId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  parent    MasterData?  @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MasterData[] @relation("Hierarchy")

  @@unique([type, name, parentId])
}

model StaffAttendance {
  id         String       @id @default(cuid())
  date       DateTime
  status     String       @default("PRESENT")
  notes      String?
  totalHours Float?       @default(0)
  userId     String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  punches    StaffPunch[]

  @@unique([userId, date])
}

model StaffPunch {
  id           String          @id @default(cuid())
  type         String
  timestamp    DateTime        @default(now())
  attendanceId String
  attendance   StaffAttendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  type      String
  reason    String?
  status    String   @default("PENDING")
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FeeStructure {
  id           String         @id @default(cuid())
  name         String
  academicYear String
  description  String?
  schoolId     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  termConfig   String?
  classIds     String         @default("[]") // JSON array of classroom IDs
  components   FeeComponent[]
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model FeeComponent {
  id             String       @id @default(cuid())
  name           String
  amount         Float
  currency       String       @default("USD")
  frequency      String
  dueDate        DateTime?
  dueDay         Int?
  dueMonth       Int?
  isOptional     Boolean      @default(false)
  isRefundable   Boolean      @default(false)
  midTermRule    String       @default("FULL")
  feeStructureId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  config         String?
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
}

model Curriculum {
  id            String          @id @default(cuid())
  name          String
  slug          String          @unique
  color         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  AcademicMonth AcademicMonth[]
  days          DayCurriculum[]
}

model DayCurriculum {
  id           String     @id @default(cuid())
  date         DateTime
  blocks       String     @default("[]")
  youtubeUrl   String?
  worksheets   String     @default("[]")
  curriculumId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@unique([curriculumId, date])
}

model SystemSettings {
  id                 String   @id @default("global")
  timezone           String   @default("UTC+05:30 (India Standard Time)")
  currency           String   @default("INR")
  mfaEnabled         Boolean  @default(true)
  sessionTimeout     Boolean  @default(false)
  allowedDomains     String?  @default("*")
  smtpHost           String?
  smtpPort           Int?     @default(587)
  smtpUser           String?
  smtpPass           String?
  smtpSender         String?  @default("noreply@pre-school.com")
  backupEnabled      Boolean  @default(true)
  backupFrequency    String   @default("DAILY")
  maintenanceMode    Boolean  @default(false)
  updatedAt          DateTime @updatedAt
  integrationsConfig String?  @default("{}")
}

model Homework {
  id           String                @id @default(cuid())
  title        String
  description  String?
  instructions String?
  videoUrl     String?
  voiceNoteUrl String?
  worksheetUrl String?
  attachments  String?
  assignedTo   String
  targetIds    String
  scheduledFor DateTime?
  dueDate      DateTime?
  isPublished  Boolean               @default(false)
  fromTemplate Boolean               @default(false)
  templateId   String?
  schoolId     String
  createdById  String
  classroomId  String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  academicYearId String?
  academicYear   AcademicYear?        @relation(fields: [academicYearId], references: [id])
  readReceipts HomeworkReadReceipt[]
  submissions  HomeworkSubmission[]

  @@index([academicYearId])
}

model HomeworkSubmission {
  id               String    @id @default(cuid())
  studentId        String
  studentName      String
  mediaType        String?
  mediaUrl         String?
  parentNotes      String?
  parentFeedback   String?
  submittedAt      DateTime?
  isSubmitted      Boolean   @default(false)
  isReviewed       Boolean   @default(false)
  reviewedAt       DateTime?
  reviewedById     String?
  stickerType      String?
  teacherComment   String?
  addedToPortfolio Boolean   @default(false)
  milestoneType    String?
  homeworkId       String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  homework         Homework  @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
}

model HomeworkReadReceipt {
  id         String   @id @default(cuid())
  homeworkId String
  parentId   String
  studentId  String
  viewedAt   DateTime @default(now())
  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, parentId, studentId])
}

model HomeworkTemplate {
  id           String   @id @default(cuid())
  title        String
  description  String?
  category     String
  instructions String?
  videoUrl     String?
  worksheetUrl String?
  attachments  String?
  isPremium    Boolean  @default(false)
  ageGroup     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  userType    String
  title       String
  message     String
  type        String
  relatedId   String?
  relatedType String?
  actionUrl   String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  sentVia     String?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, isRead])
  @@index([createdAt])
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  userType   String
  endpoint   String   @unique
  keys       String
  deviceType String?
  userAgent  String?
  isActive   Boolean  @default(true)
  lastUsed   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model NotificationSchedule {
  id             String    @id @default(cuid())
  type           String
  scheduledFor   DateTime
  targetUserId   String?
  targetUserType String?
  targetGroup    String?
  title          String
  message        String
  relatedId      String?
  relatedType    String?
  status         String    @default("PENDING")
  sentAt         DateTime?
  failureReason  String?
  sendVia        String    @default("PUSH")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([scheduledFor, status])
}

model Conversation {
  id            String    @id @default(cuid())
  studentId     String
  type          String    @default("GENERAL")
  title         String?
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([studentId, type])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  senderType     String
  senderId       String?
  senderName     String
  conversationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model DiaryEntry {
  id           String           @id @default(cuid())
  title        String
  content      String
  type         String
  scheduledFor DateTime?
  publishedAt  DateTime?
  status       String           @default("DRAFT")
  attachments  String?
  authorId     String
  schoolId     String
  classroomId  String?
  priority     String?          @default("NORMAL")
  requiresAck  Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  academicYearId String?
  academicYear   AcademicYear?   @relation(fields: [academicYearId], references: [id])
  author       User             @relation("DiaryAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classroom    Classroom?       @relation(fields: [classroomId], references: [id])
  recipients   DiaryRecipient[]

  @@index([schoolId])
  @@index([academicYearId])
  @@index([classroomId])
  @@index([authorId])
  @@index([scheduledFor])
  @@index([status])
}

model DiaryRecipient {
  id             String     @id @default(cuid())
  entryId        String
  recipientType  String
  studentId      String?
  isRead         Boolean    @default(false)
  readAt         DateTime?
  isAcknowledged Boolean    @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  createdAt      DateTime   @default(now())
  entry          DiaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  student        Student?   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([studentId])
  @@index([isRead])
}

model Role {
  id            String        @id @default(cuid())
  name          String
  description   String?
  permissions   String        @default("[]")
  isSystem      Boolean       @default(false)
  schoolId      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  leavePolicies LeavePolicy[]
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  users         User[]

  @@unique([schoolId, name])
}

model ClassAccess {
  id          String    @id @default(cuid())
  userId      String
  classroomId String
  canRead     Boolean   @default(true)
  canWrite    Boolean   @default(false)
  canEdit     Boolean   @default(false)
  canDelete   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([userId, classroomId])
}

model StaffAccess {
  id        String   @id @default(cuid())
  managerId String
  staffId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  manager   User     @relation("ManagerMapping", fields: [managerId], references: [id], onDelete: Cascade)
  staff     User     @relation("StaffMapping", fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([managerId, staffId])
}

model Payroll {
  id          String    @id @default(cuid())
  month       Int
  year        Int
  schoolId    String
  status      String    @default("DRAFT")
  generatedAt DateTime  @default(now())
  processedAt DateTime?
  totalAmount Float     @default(0)
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payslips    Payslip[]

  @@unique([schoolId, month, year])
}

model Payslip {
  id               String    @id @default(cuid())
  payrollId        String
  userId           String
  basic            Float     @default(0)
  hra              Float     @default(0)
  allowances       Float     @default(0)
  bonus            Float     @default(0)
  tax              Float     @default(0)
  pf               Float     @default(0)
  insurance        Float     @default(0)
  leaveDeduction   Float     @default(0)
  otherDeductions  Float     @default(0)
  customAdditions  String?
  customDeductions String?
  grossSalary      Float     @default(0)
  netSalary        Float     @default(0)
  totalDays        Int       @default(0)
  presentDays      Float     @default(0)
  absentDays       Float     @default(0)
  leaveDays        Float     @default(0)
  month            Int
  year             Int
  status           String    @default("UNPAID")
  paidAt           DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payroll          Payroll   @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
}

model PayrollSettings {
  id                  String   @id @default(cuid())
  schoolId            String   @unique
  fullAttendanceBonus Float    @default(0)
  punctualityBonus    Float    @default(0)
  lateThreshold       Int      @default(3)
  latePenalty         Float    @default(0)
  overtimeRate        Float    @default(0)
  workDaysPerWeek     Int      @default(6)
  standardWorkHours   Float    @default(8)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  school              School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model BiometricLog {
  id           String   @id @default(cuid())
  deviceId     String
  deviceUserId String
  timestamp    DateTime
  status       Int
  verifyMode   Int?
  processed    Boolean  @default(false)
  raw          String?
  schoolId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([deviceId, deviceUserId, timestamp])
  @@index([schoolId])
  @@index([schoolId, timestamp])
}

model LibraryBook {
  id           String               @id @default(cuid())
  title        String
  author       String
  isbn         String?
  publisher    String?
  category     String?
  coverUrl     String?
  copies       Int                  @default(1)
  shelfNo      String?
  schoolId     String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  school       School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  transactions LibraryTransaction[]

  @@index([schoolId])
  @@index([title])
  @@index([isbn])
}

model TransportVehicle {
  id                                                              String                 @id @default(cuid())
  registrationNumber                                              String
  model                                                           String?
  capacity                                                        Int
  schoolId                                                        String
  status                                                          String                 @default("ACTIVE")
  gpsDeviceId                                                     String?
  insuranceNumber                                                 String?
  insuranceExpiry                                                 DateTime?
  insuranceDocUrl                                                 String?
  pollutionNumber                                                 String?
  pollutionExpiry                                                 DateTime?
  pollutionDocUrl                                                 String?
  fitnessExpiry                                                   DateTime?
  fitnessDocUrl                                                   String?
  permitNumber                                                    String?
  permitExpiry                                                    DateTime?
  permitDocUrl                                                    String?
  rcDocUrl                                                        String?
  documents                                                       String                 @default("[]")
  createdAt                                                       DateTime               @default(now())
  updatedAt                                                       DateTime               @updatedAt
  maintenanceLogs                                                 TransportMaintenance[]
  TransportRoute_TransportRoute_dropVehicleIdToTransportVehicle   TransportRoute[]       @relation("TransportRoute_dropVehicleIdToTransportVehicle")
  TransportRoute_TransportRoute_pickupVehicleIdToTransportVehicle TransportRoute[]       @relation("TransportRoute_pickupVehicleIdToTransportVehicle")
  school                                                          School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  VehicleTelemetry                                                VehicleTelemetry[]

  @@unique([schoolId, registrationNumber])
  @@index([schoolId])
}

model TransportDriver {
  id            String           @id @default(cuid())
  name          String
  licenseNumber String
  phone         String
  schoolId      String
  status        String           @default("ACTIVE")
  userId        String?          @unique
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User?            @relation(fields: [userId], references: [id])
  school        School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  routes        TransportRoute[]

  @@index([schoolId])
}

model TransportRoute {
  id                                                                String                    @id @default(cuid())
  name                                                              String
  description                                                       String?
  schoolId                                                          String
  pickupVehicleId                                                   String?
  dropVehicleId                                                     String?
  driverId                                                          String?
  createdAt                                                         DateTime                  @default(now())
  updatedAt                                                         DateTime                  @updatedAt
  students                                                          StudentTransportProfile[]
  driver                                                            TransportDriver?          @relation(fields: [driverId], references: [id])
  TransportVehicle_TransportRoute_dropVehicleIdToTransportVehicle   TransportVehicle?         @relation("TransportRoute_dropVehicleIdToTransportVehicle", fields: [dropVehicleId], references: [id])
  TransportVehicle_TransportRoute_pickupVehicleIdToTransportVehicle TransportVehicle?         @relation("TransportRoute_pickupVehicleIdToTransportVehicle", fields: [pickupVehicleId], references: [id])
  school                                                            School                    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  stops                                                             TransportStop[]

  @@index([schoolId])
}

model TransportStop {
  id             String                    @id @default(cuid())
  name           String
  routeId        String
  sequenceOrder  Int
  latitude       Float?
  longitude      Float?
  pickupTime     String?
  dropTime       String?
  monthlyFee     Float                     @default(0)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  dropStudents   StudentTransportProfile[] @relation("DropStop")
  pickupStudents StudentTransportProfile[] @relation("PickupStop")
  route          TransportRoute            @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
}

model StudentTransportProfile {
  id                 String          @id @default(cuid())
  studentId          String          @unique
  routeId            String?
  pickupStopId       String?
  dropStopId         String?
  transportFee       Float           @default(0)
  status             String          @default("PENDING")
  startDate          DateTime?
  endDate            DateTime?
  applicationAddress String?
  applicationLat     Float?
  applicationLng     Float?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  dropStop           TransportStop?  @relation("DropStop", fields: [dropStopId], references: [id])
  pickupStop         TransportStop?  @relation("PickupStop", fields: [pickupStopId], references: [id])
  route              TransportRoute? @relation(fields: [routeId], references: [id])
  student            Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([routeId])
}

model TransportMaintenance {
  id          String           @id @default(cuid())
  vehicleId   String
  type        String
  cost        Float
  date        DateTime
  description String?
  fileUrl     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  vehicle     TransportVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

model LibraryTransaction {
  id           String      @id @default(cuid())
  bookId       String
  studentId    String?
  staffId      String?
  issuedDate   DateTime    @default(now())
  dueDate      DateTime
  returnedDate DateTime?
  status       String      @default("ISSUED")
  fineAmount   Float       @default(0)
  schoolId     String
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  staff        User?       @relation(fields: [staffId], references: [id])
  student      Student?    @relation(fields: [studentId], references: [id])
  book         LibraryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([bookId])
  @@index([studentId])
  @@index([staffId])
  @@index([status])
}

model LibrarySettings {
  id              String @id @default(cuid())
  schoolId        String @unique
  maxBooksStudent Int    @default(2)
  maxBooksStaff   Int    @default(5)
  maxDaysStudent  Int    @default(7)
  maxDaysStaff    Int    @default(14)
  finePerDay      Float  @default(10)
  school          School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model Exam {
  id               String       @id @default(cuid())
  title            String
  description      String?
  date             DateTime
  type             String       @default("TERM")
  category         String       @default("ACADEMIC")
  classrooms       String       @default("[]")
  subjects         String       @default("[]")
  maxMarks         Float        @default(100)
  minMarks         Float        @default(0)
  gradingSystem    String       @default("MARKS")
  schoolId         String
  createdById      String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  questionPaperUrl String?
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  createdBy        User         @relation(fields: [createdById], references: [id])
  school           School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  results          ExamResult[]

  @@index([schoolId])
  @@index([academicYearId])
}

model ExamResult {
  id        String   @id @default(cuid())
  marks     Float?
  grade     String?
  remarks   String?
  subject   String?
  examId    String
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String?
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId, subject])
  @@index([studentId])
}

model StudentHealthRecord {
  id            String   @id @default(cuid())
  height        Float?
  weight        Float?
  bmi           Float?
  visionLeft    String?
  visionRight   String?
  hearingLeft   String?
  hearingRight  String?
  dentalStatus  String?
  generalHealth String?
  bloodPressure String?
  pulseRate     Int?
  recordedAt    DateTime @default(now())
  recordedById  String?
  studentId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  recordedBy    User?    @relation(fields: [recordedById], references: [id])
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([academicYearId])
}

model StudentActivityRecord {
  id          String   @id @default(cuid())
  title       String
  category    String
  type        String
  date        DateTime
  description String?
  achievement String?
  studentId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([academicYearId])
}

model AcademicDay {
  id            String        @id
  monthId       String
  dayNumber     Int
  title         String?
  theme         String?
  blocks        String        @default("[]")
  worksheets    String        @default("[]")
  isCompleted   Boolean       @default(false)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  AcademicMonth AcademicMonth @relation(fields: [monthId], references: [id], onDelete: Cascade)

  @@unique([monthId, dayNumber])
  @@index([monthId])
}

model AcademicMonth {
  id           String        @id
  curriculumId String
  monthNumber  Int
  title        String
  description  String?
  theme        String?
  objectives   String        @default("[]")
  startDate    DateTime?
  endDate      DateTime?
  isCompleted  Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime
  AcademicDay  AcademicDay[]
  Curriculum   Curriculum    @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@unique([curriculumId, monthNumber])
  @@index([curriculumId])
}

model BlogPageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model BlogPost {
  id              String    @id
  title           String
  slug            String    @unique
  excerpt         String?
  content         String
  coverImage      String?
  authorId        String
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  tags            String    @default("[]")
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [authorId], references: [id])
}

model CMSPage {
  id              String   @id
  title           String
  slug            String   @unique
  content         String
  isPublished     Boolean  @default(false)
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
}

model CareersPageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model ContactPageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model FeaturesPageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model HomepageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model JobApplication {
  id          String     @id
  firstName   String
  lastName    String
  email       String
  phone       String
  resumeUrl   String?
  coverLetter String?
  linkedin    String?
  portfolio   String?
  status      String     @default("PENDING")
  jobId       String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  JobPosting  JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([jobId])
}

model JobPosting {
  id             String           @id
  title          String
  department     String
  location       String
  type           String
  description    String
  requirements   String?
  isOpen         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  JobApplication JobApplication[]
}

model PricingPageContent {
  id         String   @id
  sectionKey String   @unique
  title      String?
  subtitle   String?
  content    String
  isEnabled  Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model TrainingAttachment {
  id           String       @id
  pageId       String
  name         String
  url          String
  size         Int          @default(0)
  type         String       @default("file")
  createdAt    DateTime     @default(now())
  TrainingPage TrainingPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model TrainingCategory {
  id             String           @id
  name           String           @unique
  slug           String           @unique
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  TrainingModule TrainingModule[]
}

model TrainingModule {
  id               String            @id
  title            String
  description      String?
  cover            String?
  role             String            @default("TEACHER")
  categoryId       String?
  isPublished      Boolean           @default(false)
  slug             String            @unique
  order            Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  TrainingCategory TrainingCategory? @relation(fields: [categoryId], references: [id])
  TrainingTopic    TrainingTopic[]
}

model TrainingPage {
  id                 String               @id
  topicId            String
  title              String
  content            String
  order              Int                  @default(0)
  isPublished        Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  TrainingAttachment TrainingAttachment[]
  TrainingTopic      TrainingTopic        @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([topicId])
}

model TrainingTopic {
  id             String         @id
  moduleId       String
  title          String
  description    String?
  order          Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  TrainingPage   TrainingPage[]
  TrainingModule TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
}

model VehicleTelemetry {
  id               String           @id
  vehicleId        String
  latitude         Float
  longitude        Float
  heading          Float?
  speed            Float?
  status           String           @default("MOVING")
  delayMinutes     Int              @default(0)
  nextStopId       String?
  recordedAt       DateTime         @default(now())
  createdAt        DateTime         @default(now())
  TransportVehicle TransportVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([recordedAt])
  @@index([vehicleId])
}

// ============================================================================
// MARKETING MATERIALS MODULE
// ============================================================================

model MarketingTemplate {
  id           String   @id @default(cuid())
  name         String
  type         String   // SOCIAL_POST, BROCHURE, FLYER, WHATSAPP, etc.
  category     String   // e.g., "Admissions", "Events", "Holidays"
  baseImageUrl String   // URL of the high-res source image
  previewUrl   String?  // URL of the thumbnail
  config       String   @default("{}") // JSON string for customization zones
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type])
  @@index([category])
  designs      SchoolMarketingDesign[]
}

model MarketingAttribute {
  id        String   @id @default(cuid())
  type      String   // "FORMAT" or "CATEGORY"
  name      String
  createdAt DateTime @default(now())

  @@unique([type, name])
  @@index([type])
}

model SchoolMarketingDesign {
  id             String            @id @default(cuid())
  schoolId       String
  templateId     String
  customValues   String            @default("{}") // JSON: { zoneId: "value" }
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  template       MarketingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([schoolId, templateId])
  @@index([schoolId])
  @@index([templateId])
}




model Branch {
  id        String   @id @default(cuid())
  name      String
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  leads     Lead[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id                     String            @id @default(cuid())
  parentName             String
  mobile                 String
  childName              String
  childAge               Int?
  childDOB               DateTime?
  programInterested      String?
  preferredBranchId      String?
  branch                 Branch?           @relation(fields: [preferredBranchId], references: [id])
  source                 String?           // Website, Ads, WhatsApp, Walk-in, etc.
  status                 String            @default("NEW") // Pipeline stages
  priority               String            @default("MEDIUM")
  score                  Int               @default(50)
  counsellorId           String?
  counsellor             User?             @relation("LeadCounsellor", fields: [counsellorId], references: [id])
  
  // Scoring Metrics
  firstResponseTime      Int?              // in minutes
  lastMeaningfulActionAt DateTime?
  tourStatus             String            @default("NONE") // NONE, SCHEDULED, COMPLETED
  feeConcernLevel        String            @default("NONE") // NONE, MILD, STRONG
  distanceConcern        Boolean           @default(false)
  timingConcern          Boolean           @default(false)
  programFit             String            @default("GOOD") // GOOD, CLOSE, BAD
  seatAvailability       String            @default("AVAILABLE") // AVAILABLE, WAITLIST
  
  // Engagement
  whatsappRead           Boolean           @default(false)
  linkClicks             Int               @default(0)
  repliesCount           Int               @default(0)
  callConnectedCount     Int               @default(0)
  noAnswerCount          Int               @default(0)
  isReferral             Boolean           @default(false)
  
  // Consent
  consentWhatsApp        Boolean           @default(false)
  consentCalls           Boolean           @default(false)
  
  schoolId               String
  school                 School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  interactions           LeadInteraction[]
  followUps              FollowUp[]
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([mobile])
}

model FollowUp {
  id           String   @id @default(cuid())
  leadId       String?
  lead         Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  admissionId  String?
  admission    Admission? @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  type         String   // CALL, WHATSAPP, VISIT
  scheduledAt  DateTime
  completedAt  DateTime?
  status       String   @default("PENDING") // PENDING, COMPLETED, CANCELLED, OVERDUE
  notes        String?
  assignedToId String?
  assignedTo   User?    @relation(fields: [assignedToId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([leadId])
  @@index([assignedToId])
}

model LeadInteraction {
  id         String   @id @default(cuid())
  leadId     String?
  lead         Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  admissionId String?
  admission   Admission? @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  type       String   // CALL_LOG, WHATSAPP_MSG, NOTE, STATUS_CHANGE, AUTOMATION
  content    String
  staffId    String?
  staff      User?    @relation(fields: [staffId], references: [id])
  createdAt  DateTime @default(now())

  @@index([leadId])
}

model WhatsAppTemplate {
  id           String   @id @default(cuid())
  name         String
  category     String   // ADMISSION, PAYMENT, TOUR, VALUE, NURTURE, REENGAGEMENT
  body         String
  variables    String?  // JSON string: list of variable names
  language     String   @default("EN")
  scoreBands   String   // JSON string: array of score bands
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([schoolId])
}

model LeadAutomationRule {
  id           String   @id @default(cuid())
  scoreBand    String   // HOT, WARM, COOL, COLD
  frequency    Int      // hours between messages
  maxMessages  Int
  allowedCats  String   // JSON string: array of categories
  isEnabled    Boolean  @default(true)
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([schoolId, scoreBand])
}

model AISettings {
  id                      String   @id @default(cuid())
  weights                 String?  @default("{}") // JSON string for factor weights
  automationRules         String?  @default("{}") // JSON string for thresholds
  globalAutomationEnabled Boolean  @default(true)
  quietHours              String?  @default("{\"start\":\"20:00\",\"end\":\"09:00\"}") // JSON string
  schoolId                String   @unique
  school                  School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}
