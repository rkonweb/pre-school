generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model School {
  id                String         @id @default(cuid())
  name              String
  slug              String         @unique
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  address           String?
  email             String?
  phone             String?
  brandColor        String?        @default("#2563eb")
  city              String?
  country           String?
  currency          String?        @default("USD")
  dateFormat        String?        @default("MM/DD/YYYY")
  facebook          String?
  foundingYear      String?
  instagram         String?
  latitude          String?
  linkedin          String?
  logo              String?
  longitude         String?
  motto             String?
  state             String?
  timezone          String?        @default("UTC-5 (EST)")
  twitter           String?
  website           String?
  youtube           String?
  zip               String?
  googleMapsApiKey  String?
  academicYearEnd   DateTime?
  academicYearStart DateTime?
  primaryColor      String?        @default("#2563eb")
  schoolTimings     String?        @default("9:00 AM - 3:00 PM")
  secondaryColor    String?
  workingDays       String?
  timetableConfig   String?        @default("{}")
  customDomain      String?        @unique
  admissions        Admission[]
  classrooms        Classroom[]
  diaryEntries      DiaryEntry[]
  feeStructures     FeeStructure[]
  leavePolicies     LeavePolicy[]
  roles             Role[]
  students          Student[]
  subscription      Subscription?
  users             User[]
}

model Admission {
  id                    String    @id @default(cuid())
  studentName           String
  studentAge            Int?
  studentGender         String?
  dateOfBirth           DateTime?
  parentName            String
  parentEmail           String?
  parentPhone           String?
  secondaryPhone        String?
  relationship          String?
  fatherName            String?
  fatherPhone           String?
  fatherEmail           String?
  fatherOccupation      String?
  motherName            String?
  motherPhone           String?
  motherEmail           String?
  motherOccupation      String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  zip                   String?
  officialStatus        String?   @default("INTERESTED")
  stage                 String    @default("INQUIRY")
  priority              String    @default("MEDIUM")
  enrolledGrade         String?
  source                String?
  notes                 String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  previousSchool        String?
  documents             String?
  accessToken           String?   @unique
  admissionFormStep     Int       @default(0)
  dateReceived          DateTime  @default(now())
  schoolId              String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  school                School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([stage])
  @@index([parentPhone])
  @@index([parentEmail])
}

model User {
  id                       String            @id @default(cuid())
  mobile                   String            @unique
  email                    String?
  firstName                String?
  lastName                 String?
  designation              String?
  department               String?
  joiningDate              DateTime?
  status                   String            @default("ACTIVE")
  avatar                   String?
  address                  String?
  role                     String            @default("ADMIN")
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  schoolId                 String?
  documents                String?
  gender                   String?
  dateOfBirth              DateTime?
  bloodGroup               String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  addressCity              String?
  addressState             String?
  addressZip               String?
  addressCountry           String?
  qualifications           String?
  experience               String?
  employmentType           String?
  subjects                 String?
  bankName                 String?
  bankAccountNo            String?
  bankIfsc                 String?
  facebook                 String?
  linkedin                 String?
  twitter                  String?
  instagram                String?
  customRoleId             String?
  classAccesses            ClassAccess[]
  managedClassrooms        Classroom[]       @relation("ClassTeacher")
  diaryEntries             DiaryEntry[]      @relation("DiaryAuthor")
  leaveBalances            LeaveBalance[]
  leaveRequests            LeaveRequest[]
  salaryRevisions          SalaryRevision[]
  managedBy                StaffAccess[]     @relation("StaffMapping")
  managedStaff             StaffAccess[]     @relation("ManagerMapping")
  staffAttendance          StaffAttendance[]
  customRole               Role?             @relation(fields: [customRoleId], references: [id])
  school                   School?           @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
  @@index([role])
  @@index([status])
}

model LeavePolicy {
  id                  String      @id @default(cuid())
  name                String
  description         String?
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  isDefault           Boolean     @default(false)
  schoolId            String
  lateComingGrace     Int         @default(15)
  lateComingMax       Int         @default(60)
  earlyLeavingGrace   Int         @default(15)
  earlyLeavingMax     Int         @default(60)
  minFullDayHours     Float       @default(8.0)
  minHalfDayHours     Float       @default(4.0)
  maxDailyPunchEvents Int         @default(10)
  minPunchGapMins     Int         @default(0)
  roleId              String?
  permissionAllowed   Boolean     @default(true)
  permissionMaxMins   Int         @default(120)
  permissionMaxOccur  Int         @default(2)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  role                Role?       @relation(fields: [roleId], references: [id])
  school              School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  leaveTypes          LeaveType[]
}

model LeaveType {
  id               String         @id @default(cuid())
  name             String
  code             String
  totalDays        Float
  canCarryForward  Boolean        @default(false)
  maxCarryForward  Float          @default(0)
  isPaid           Boolean        @default(true)
  allowHalfDay     Boolean        @default(true)
  minNoticePeriod  Int            @default(0)
  requiresApproval Boolean        @default(true)
  gender           String?
  policyId         String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  leaveBalances    LeaveBalance[]
  policy           LeavePolicy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
}

model LeaveBalance {
  id          String    @id @default(cuid())
  total       Float
  used        Float     @default(0)
  pending     Float     @default(0)
  remaining   Float
  userId      String
  leaveTypeId String
  year        Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leaveTypeId, year])
}

model SalaryRevision {
  id              String   @id @default(cuid())
  amount          Float
  currency        String   @default("INR")
  revisionDate    DateTime @default(now())
  effectiveDate   DateTime
  reason          String?
  type            String   @default("INCREMENT")
  basic           Float    @default(0)
  hra             Float    @default(0)
  allowance       Float    @default(0)
  tax             Float    @default(0)
  pf              Float    @default(0)
  insurance       Float    @default(0)
  otherDeductions Float    @default(0)
  netSalary       Float    @default(0)
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Classroom {
  id           String        @id @default(cuid())
  name         String
  schoolId     String
  teacherId    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  capacity     Int?          @default(30)
  roomNumber   String?
  timetable    String?       @default("[]")
  accesses     ClassAccess[]
  teacher      User?         @relation("ClassTeacher", fields: [teacherId], references: [id])
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  diaryEntries DiaryEntry[]
  students     Student[]

  @@index([schoolId])
}

model Student {
  id                    String           @id @default(cuid())
  firstName             String
  lastName              String
  avatar                String?
  age                   Int?
  gender                String?
  dateOfBirth           DateTime?
  grade                 String?
  status                String           @default("ACTIVE")
  parentName            String?
  parentMobile          String?
  parentEmail           String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  classroomId           String?
  schoolId              String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  admissionNumber       String?
  joiningDate           DateTime?
  attendance            Attendance[]
  conversations         Conversation[]
  diaryRecipients       DiaryRecipient[]
  fees                  Fee[]
  reports               ReportCard[]
  school                School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classroom             Classroom?       @relation(fields: [classroomId], references: [id])

  @@index([schoolId])
  @@index([classroomId])
  @@index([status])
}

model Fee {
  id          String       @id @default(cuid())
  title       String
  amount      Float
  dueDate     DateTime
  status      String       @default("PENDING")
  studentId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  description String?
  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments    FeePayment[]
}

model FeePayment {
  id        String   @id @default(cuid())
  amount    Float
  date      DateTime @default(now())
  method    String
  reference String?
  feeId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  fee       Fee      @relation(fields: [feeId], references: [id], onDelete: Cascade)
}

model Attendance {
  id        String   @id @default(cuid())
  date      DateTime
  status    String
  notes     String?
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
}

model ReportCard {
  id        String   @id @default(cuid())
  term      String
  marks     String
  comments  String?
  published Boolean  @default(false)
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Otp {
  id        String   @id @default(cuid())
  mobile    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model SubscriptionPlan {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  description     String?
  price           Float          @default(0)
  currency        String         @default("INR")
  billingPeriod   String         @default("monthly")
  features        String         @default("[]")
  maxStudents     Int            @default(0)
  maxStaff        Int            @default(0)
  maxStorageGB    Int            @default(0)
  tier            String         @default("free")
  supportLevel    String         @default("community")
  isActive        Boolean        @default(true)
  isPopular       Boolean        @default(false)
  includedModules String         @default("[]")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  subscriptions   Subscription[]
}

model Subscription {
  id        String           @id @default(cuid())
  status    String           @default("TRIAL")
  startDate DateTime         @default(now())
  endDate   DateTime?
  planId    String
  schoolId  String           @unique
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
}

model MasterData {
  id        String       @id @default(cuid())
  type      String
  name      String
  code      String?
  parentId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  parent    MasterData?  @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MasterData[] @relation("Hierarchy")

  @@unique([type, name, parentId])
}

model StaffAttendance {
  id         String       @id @default(cuid())
  date       DateTime
  status     String       @default("PRESENT")
  notes      String?
  totalHours Float?       @default(0)
  userId     String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  punches    StaffPunch[]

  @@unique([userId, date])
}

model StaffPunch {
  id           String          @id @default(cuid())
  type         String
  timestamp    DateTime        @default(now())
  attendanceId String
  attendance   StaffAttendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  type      String
  reason    String?
  status    String   @default("PENDING")
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FeeStructure {
  id           String         @id @default(cuid())
  name         String
  academicYear String
  description  String?
  schoolId     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  termConfig   String?
  components   FeeComponent[]
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model FeeComponent {
  id             String       @id @default(cuid())
  name           String
  amount         Float
  currency       String       @default("USD")
  frequency      String
  dueDate        DateTime?
  dueDay         Int?
  dueMonth       Int?
  isOptional     Boolean      @default(false)
  isRefundable   Boolean      @default(false)
  midTermRule    String       @default("FULL")
  feeStructureId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  config         String?
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
}

model Curriculum {
  id        String          @id @default(cuid())
  name      String
  slug      String          @unique
  color     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  days      DayCurriculum[]
}

model DayCurriculum {
  id           String     @id @default(cuid())
  date         DateTime
  blocks       String     @default("[]")
  youtubeUrl   String?
  worksheets   String     @default("[]")
  curriculumId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@unique([curriculumId, date])
}

model SystemSettings {
  id              String   @id @default("global")
  timezone        String   @default("UTC+05:30 (India Standard Time)")
  currency        String   @default("INR")
  mfaEnabled      Boolean  @default(true)
  sessionTimeout  Boolean  @default(false)
  allowedDomains  String?  @default("*")
  smtpHost        String?
  smtpPort        Int?     @default(587)
  smtpUser        String?
  smtpPass        String?
  smtpSender      String?  @default("noreply@pre-school.com")
  backupEnabled   Boolean  @default(true)
  backupFrequency String   @default("DAILY")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt
}

model Homework {
  id           String                @id @default(cuid())
  title        String
  description  String?
  instructions String?
  videoUrl     String?
  voiceNoteUrl String?
  worksheetUrl String?
  attachments  String?
  assignedTo   String
  targetIds    String
  scheduledFor DateTime?
  dueDate      DateTime?
  isPublished  Boolean               @default(false)
  fromTemplate Boolean               @default(false)
  templateId   String?
  schoolId     String
  createdById  String
  classroomId  String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  readReceipts HomeworkReadReceipt[]
  submissions  HomeworkSubmission[]
}

model HomeworkSubmission {
  id               String    @id @default(cuid())
  studentId        String
  studentName      String
  mediaType        String?
  mediaUrl         String?
  parentNotes      String?
  parentFeedback   String?
  submittedAt      DateTime?
  isSubmitted      Boolean   @default(false)
  isReviewed       Boolean   @default(false)
  reviewedAt       DateTime?
  reviewedById     String?
  stickerType      String?
  teacherComment   String?
  addedToPortfolio Boolean   @default(false)
  milestoneType    String?
  homeworkId       String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  homework         Homework  @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
}

model HomeworkReadReceipt {
  id         String   @id @default(cuid())
  homeworkId String
  parentId   String
  studentId  String
  viewedAt   DateTime @default(now())
  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, parentId, studentId])
}

model HomeworkTemplate {
  id           String   @id @default(cuid())
  title        String
  description  String?
  category     String
  instructions String?
  videoUrl     String?
  worksheetUrl String?
  attachments  String?
  isPremium    Boolean  @default(false)
  ageGroup     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  userType    String
  title       String
  message     String
  type        String
  relatedId   String?
  relatedType String?
  actionUrl   String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  sentVia     String?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, isRead])
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  userType   String
  endpoint   String   @unique
  keys       String
  deviceType String?
  userAgent  String?
  isActive   Boolean  @default(true)
  lastUsed   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model NotificationSchedule {
  id             String    @id @default(cuid())
  type           String
  scheduledFor   DateTime
  targetUserId   String?
  targetUserType String?
  targetGroup    String?
  title          String
  message        String
  relatedId      String?
  relatedType    String?
  status         String    @default("PENDING")
  sentAt         DateTime?
  failureReason  String?
  sendVia        String    @default("PUSH")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([scheduledFor, status])
}

model Conversation {
  id            String    @id @default(cuid())
  studentId     String
  type          String    @default("GENERAL")
  title         String?
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([studentId, type])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  senderType     String
  senderId       String?
  senderName     String
  conversationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model DiaryEntry {
  id           String           @id @default(cuid())
  title        String
  content      String
  type         String
  scheduledFor DateTime?
  publishedAt  DateTime?
  status       String           @default("DRAFT")
  attachments  String?
  authorId     String
  schoolId     String
  classroomId  String?
  priority     String?          @default("NORMAL")
  requiresAck  Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  classroom    Classroom?       @relation(fields: [classroomId], references: [id])
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  author       User             @relation("DiaryAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  recipients   DiaryRecipient[]

  @@index([schoolId])
  @@index([classroomId])
  @@index([authorId])
  @@index([scheduledFor])
  @@index([status])
}

model DiaryRecipient {
  id             String     @id @default(cuid())
  entryId        String
  recipientType  String
  studentId      String?
  isRead         Boolean    @default(false)
  readAt         DateTime?
  isAcknowledged Boolean    @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  createdAt      DateTime   @default(now())
  student        Student?   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  entry          DiaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([studentId])
  @@index([isRead])
}

model Role {
  id            String        @id @default(cuid())
  name          String
  description   String?
  permissions   String        @default("[]")
  isSystem      Boolean       @default(false)
  schoolId      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  leavePolicies LeavePolicy[]
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  users         User[]

  @@unique([schoolId, name])
}

model ClassAccess {
  id          String    @id @default(cuid())
  userId      String
  classroomId String
  canRead     Boolean   @default(true)
  canWrite    Boolean   @default(false)
  canEdit     Boolean   @default(false)
  canDelete   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, classroomId])
}

model StaffAccess {
  id        String   @id @default(cuid())
  managerId String
  staffId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     User     @relation("StaffMapping", fields: [staffId], references: [id], onDelete: Cascade)
  manager   User     @relation("ManagerMapping", fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([managerId, staffId])
}
