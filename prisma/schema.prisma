generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model School {
  id                String         @id @default(cuid())
  name              String
  slug              String         @unique
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  address           String?
  email             String?
  phone             String?
  brandColor        String?        @default("#2563eb")
  city              String?
  country           String?
  currency          String?        @default("USD")
  dateFormat        String?        @default("MM/DD/YYYY")
  facebook          String?
  foundingYear      String?
  instagram         String?
  latitude          String?
  linkedin          String?
  logo              String?
  longitude         String?
  motto             String?
  state             String?
  timezone          String?        @default("UTC-5 (EST)")
  twitter           String?
  website           String?
  youtube           String?
  zip               String?
  googleMapsApiKey  String?
  academicYearEnd   DateTime?
  academicYearStart DateTime?
  primaryColor      String?        @default("#2563eb")
  schoolTimings     String?        @default("9:00 AM - 3:00 PM")
  secondaryColor    String?
  workingDays       String?
  timetableConfig   String?        @default("{}")
  customDomain      String?        @unique
  admissions        Admission[]
  classrooms        Classroom[]
  diaryEntries      DiaryEntry[]
  feeStructures     FeeStructure[]
  leavePolicies     LeavePolicy[]
  payrolls          Payroll[]
  roles             Role[]
  students          Student[]
  subscription      Subscription?
  users             User[]
  payrollSettings   PayrollSettings?
  modulesConfig     String?        @default("[]")
  addonsConfig      String?        @default("[]")
  biometricLogs     BiometricLog[]
  libraryBooks      LibraryBook[]
  libraryTransactions LibraryTransaction[]
  librarySettings   LibrarySettings?
  
  // Transport
  transportVehicles TransportVehicle[]
  transportDrivers  TransportDriver[]
  transportRoutes   TransportRoute[]
  
  // Academics & Progress
  exams             Exam[]
  
  // Integrations (WhatsApp, SMS, Payments etc) - JSON String
  integrationsConfig String?        @default("{}")
}

model Admission {
  id                    String    @id @default(cuid())
  studentName           String
  studentAge            Int?
  studentGender         String?
  dateOfBirth           DateTime?
  parentName            String
  parentEmail           String?
  parentPhone           String?
  secondaryPhone        String?
  relationship          String?
  fatherName            String?
  fatherPhone           String?
  fatherEmail           String?
  fatherOccupation      String?
  motherName            String?
  motherPhone           String?
  motherEmail           String?
  motherOccupation      String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  zip                   String?
  officialStatus        String?   @default("INTERESTED")
  stage                 String    @default("INQUIRY")
  priority              String    @default("MEDIUM")
  enrolledGrade         String?
  source                String?
  notes                 String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  previousSchool        String?
  documents             String?
  accessToken           String?   @unique
  admissionFormStep     Int       @default(0)
  dateReceived          DateTime  @default(now())
  schoolId              String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  school                School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([stage])
  @@index([parentPhone])
  @@index([parentEmail])
}

model User {
  id                       String            @id @default(cuid())
  mobile                   String            @unique
  email                    String?
  firstName                String?
  lastName                 String?
  designation              String?
  department               String?
  joiningDate              DateTime?
  status                   String            @default("ACTIVE")
  avatar                   String?
  address                  String?
  role                     String            @default("ADMIN")
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  schoolId                 String?
  documents                String?
  gender                   String?
  dateOfBirth              DateTime?
  bloodGroup               String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  addressCity              String?
  addressState             String?
  addressZip               String?
  addressCountry           String?
  qualifications           String?
  experience               String?
  employmentType           String?
  subjects                 String?
  bankName                 String?
  bankAccountNo            String?
  bankIfsc                 String?
  facebook                 String?
  linkedin                 String?
  twitter                  String?
  instagram                String?
  customRoleId             String?
  classAccesses            ClassAccess[]
  managedClassrooms        Classroom[]       @relation("ClassTeacher")
  diaryEntries             DiaryEntry[]      @relation("DiaryAuthor")
  leaveBalances            LeaveBalance[]
  leaveRequests            LeaveRequest[]
  salaryRevisions          SalaryRevision[]
  managedBy                StaffAccess[]     @relation("StaffMapping")
  managedStaff             StaffAccess[]     @relation("ManagerMapping")
  staffAttendance          StaffAttendance[]
  customRole               Role?             @relation(fields: [customRoleId], references: [id])
  biometricId              String?           @unique
  school                   School?           @relation(fields: [schoolId], references: [id])
  payslips                 Payslip[]
  libraryTransactions      LibraryTransaction[]

  @@index([role])
  @@index([status])
  transportDriver TransportDriver?
  
  // Progress & Exams
  createdExams    Exam[]
  recordedHealth  StudentHealthRecord[]
  
  // CMS
  blogPosts       BlogPost[]
}

model LeavePolicy {
  id                  String      @id @default(cuid())
  name                String
  description         String?
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  isDefault           Boolean     @default(false)
  schoolId            String
  lateComingGrace     Int         @default(15)
  lateComingMax       Int         @default(60)
  earlyLeavingGrace   Int         @default(15)
  earlyLeavingMax     Int         @default(60)
  minFullDayHours     Float       @default(8.0)
  minHalfDayHours     Float       @default(4.0)
  maxDailyPunchEvents Int         @default(10)
  minPunchGapMins     Int         @default(0)
  roleId              String?
  permissionAllowed   Boolean     @default(true)
  permissionMaxMins   Int         @default(120)
  permissionMaxOccur  Int         @default(2)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  role                Role?       @relation(fields: [roleId], references: [id])
  school              School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  leaveTypes          LeaveType[]
}

model LeaveType {
  id               String         @id @default(cuid())
  name             String
  code             String
  totalDays        Float
  canCarryForward  Boolean        @default(false)
  maxCarryForward  Float          @default(0)
  isPaid           Boolean        @default(true)
  allowHalfDay     Boolean        @default(true)
  minNoticePeriod  Int            @default(0)
  requiresApproval Boolean        @default(true)
  gender           String?
  policyId         String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  leaveBalances    LeaveBalance[]
  policy           LeavePolicy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
}

model LeaveBalance {
  id          String    @id @default(cuid())
  total       Float
  used        Float     @default(0)
  pending     Float     @default(0)
  remaining   Float
  userId      String
  leaveTypeId String
  year        Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leaveTypeId, year])
}

model SalaryRevision {
  id              String   @id @default(cuid())
  amount          Float
  currency        String   @default("INR")
  revisionDate    DateTime @default(now())
  effectiveDate   DateTime
  reason          String?
  type            String   @default("INCREMENT")
  basic           Float    @default(0)
  hra             Float    @default(0)
  allowance       Float    @default(0)
  tax             Float    @default(0)
  pf              Float    @default(0)
  insurance       Float    @default(0)
  otherDeductions String?   // For legacy support or simple notes
  customAdditions String?   // JSON Array of {label, amount}
  customDeductions String?  // JSON Array of {label, amount}
  netSalary       Float    @default(0)
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Classroom {
  id           String        @id @default(cuid())
  name         String
  schoolId     String
  teacherId    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  capacity     Int?          @default(30)
  roomNumber   String?
  timetable    String?       @default("[]")
  accesses     ClassAccess[]
  teacher      User?         @relation("ClassTeacher", fields: [teacherId], references: [id])
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  diaryEntries DiaryEntry[]
  students     Student[]

  @@index([schoolId])
}

model Student {
  id                    String           @id @default(cuid())
  firstName             String
  lastName              String
  avatar                String?
  age                   Int?
  gender                String?
  dateOfBirth           DateTime?
  grade                 String?
  status                String           @default("ACTIVE")
  parentName            String?
  parentMobile          String?
  parentEmail           String?
  bloodGroup            String?
  medicalConditions     String?
  allergies             String?
  emergencyContactName  String?
  emergencyContactPhone String?
  classroomId           String?
  transportProfile      StudentTransportProfile?
  schoolId              String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  admissionNumber       String?
  joiningDate           DateTime?
  attendance            Attendance[]
  conversations         Conversation[]
  diaryRecipients       DiaryRecipient[]
  fees                  Fee[]
  reports               ReportCard[]
  school                School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classroom             Classroom?       @relation(fields: [classroomId], references: [id])
  libraryTransactions   LibraryTransaction[]

  // Progress Module
  examResults           ExamResult[]
  healthRecords         StudentHealthRecord[]
  activityRecords       StudentActivityRecord[]

  @@index([schoolId])
  @@index([classroomId])
  @@index([status])
}

model Fee {
  id          String       @id @default(cuid())
  title       String
  amount      Float
  dueDate     DateTime
  status      String       @default("PENDING")
  studentId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  description String?
  student     Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments    FeePayment[]
}

model FeePayment {
  id        String   @id @default(cuid())
  amount    Float
  date      DateTime @default(now())
  method    String
  reference String?
  feeId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  fee       Fee      @relation(fields: [feeId], references: [id], onDelete: Cascade)
}

model Attendance {
  id        String   @id @default(cuid())
  date      DateTime
  status    String
  notes     String?
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
}

model ReportCard {
  id        String   @id @default(cuid())
  term      String
  marks     String
  comments  String?
  published Boolean  @default(false)
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Otp {
  id        String   @id @default(cuid())
  mobile    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model SubscriptionPlan {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  description     String?
  price           Float          @default(0)
  currency        String         @default("INR")
  billingPeriod   String         @default("monthly")
  features        String         @default("[]")
  maxStudents     Int            @default(0)
  maxStaff        Int            @default(0)
  maxStorageGB    Int            @default(0)
  tier            String         @default("free")
  supportLevel    String         @default("community")
  isActive        Boolean        @default(true)
  isPopular       Boolean        @default(false)
  includedModules String         @default("[]")
  sortOrder       Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  subscriptions   Subscription[]
}

model Subscription {
  id        String           @id @default(cuid())
  status    String           @default("TRIAL")
  startDate DateTime         @default(now())
  endDate   DateTime?
  planId    String
  schoolId  String           @unique
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
}

model MasterData {
  id        String       @id @default(cuid())
  type      String
  name      String
  code      String?
  parentId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  parent    MasterData?  @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  MasterData[] @relation("Hierarchy")

  @@unique([type, name, parentId])
}

model StaffAttendance {
  id         String       @id @default(cuid())
  date       DateTime
  status     String       @default("PRESENT")
  notes      String?
  totalHours Float?       @default(0)
  userId     String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  punches    StaffPunch[]

  @@unique([userId, date])
}

model StaffPunch {
  id           String          @id @default(cuid())
  type         String
  timestamp    DateTime        @default(now())
  attendanceId String
  attendance   StaffAttendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  type      String
  reason    String?
  status    String   @default("PENDING")
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FeeStructure {
  id           String         @id @default(cuid())
  name         String
  academicYear String
  description  String?
  schoolId     String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  termConfig   String?
  components   FeeComponent[]
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model FeeComponent {
  id             String       @id @default(cuid())
  name           String
  amount         Float
  currency       String       @default("USD")
  frequency      String
  dueDate        DateTime?
  dueDay         Int?
  dueMonth       Int?
  isOptional     Boolean      @default(false)
  isRefundable   Boolean      @default(false)
  midTermRule    String       @default("FULL")
  feeStructureId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  config         String?
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
}

model Curriculum {
  id        String          @id @default(cuid())
  name      String
  slug      String          @unique
  color     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  days      DayCurriculum[]
}

model DayCurriculum {
  id           String     @id @default(cuid())
  date         DateTime
  blocks       String     @default("[]")
  youtubeUrl   String?
  worksheets   String     @default("[]")
  curriculumId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@unique([curriculumId, date])
}

model SystemSettings {
  id              String   @id @default("global")
  timezone        String   @default("UTC+05:30 (India Standard Time)")
  currency        String   @default("INR")
  mfaEnabled      Boolean  @default(true)
  sessionTimeout  Boolean  @default(false)
  allowedDomains  String?  @default("*")
  smtpHost        String?
  smtpPort        Int?     @default(587)
  smtpUser        String?
  smtpPass        String?
  smtpSender      String?  @default("noreply@pre-school.com")
  backupEnabled   Boolean  @default(true)
  backupFrequency String   @default("DAILY")
  maintenanceMode Boolean  @default(false)
  updatedAt       DateTime @updatedAt
}

model Homework {
  id           String                @id @default(cuid())
  title        String
  description  String?
  instructions String?
  videoUrl     String?
  voiceNoteUrl String?
  worksheetUrl String?
  attachments  String?
  assignedTo   String
  targetIds    String
  scheduledFor DateTime?
  dueDate      DateTime?
  isPublished  Boolean               @default(false)
  fromTemplate Boolean               @default(false)
  templateId   String?
  schoolId     String
  createdById  String
  classroomId  String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  readReceipts HomeworkReadReceipt[]
  submissions  HomeworkSubmission[]
}

model HomeworkSubmission {
  id               String    @id @default(cuid())
  studentId        String
  studentName      String
  mediaType        String?
  mediaUrl         String?
  parentNotes      String?
  parentFeedback   String?
  submittedAt      DateTime?
  isSubmitted      Boolean   @default(false)
  isReviewed       Boolean   @default(false)
  reviewedAt       DateTime?
  reviewedById     String?
  stickerType      String?
  teacherComment   String?
  addedToPortfolio Boolean   @default(false)
  milestoneType    String?
  homeworkId       String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  homework         Homework  @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, studentId])
}

model HomeworkReadReceipt {
  id         String   @id @default(cuid())
  homeworkId String
  parentId   String
  studentId  String
  viewedAt   DateTime @default(now())
  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, parentId, studentId])
}

model HomeworkTemplate {
  id           String   @id @default(cuid())
  title        String
  description  String?
  category     String
  instructions String?
  videoUrl     String?
  worksheetUrl String?
  attachments  String?
  isPremium    Boolean  @default(false)
  ageGroup     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Notification {
  id          String    @id @default(cuid())
  userId      String
  userType    String
  title       String
  message     String
  type        String
  relatedId   String?
  relatedType String?
  actionUrl   String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  sentVia     String?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, isRead])
  @@index([createdAt])
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  userType   String
  endpoint   String   @unique
  keys       String
  deviceType String?
  userAgent  String?
  isActive   Boolean  @default(true)
  lastUsed   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model NotificationSchedule {
  id             String    @id @default(cuid())
  type           String
  scheduledFor   DateTime
  targetUserId   String?
  targetUserType String?
  targetGroup    String?
  title          String
  message        String
  relatedId      String?
  relatedType    String?
  status         String    @default("PENDING")
  sentAt         DateTime?
  failureReason  String?
  sendVia        String    @default("PUSH")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([scheduledFor, status])
}

model Conversation {
  id            String    @id @default(cuid())
  studentId     String
  type          String    @default("GENERAL")
  title         String?
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([studentId, type])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  senderType     String
  senderId       String?
  senderName     String
  conversationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model DiaryEntry {
  id           String           @id @default(cuid())
  title        String
  content      String
  type         String
  scheduledFor DateTime?
  publishedAt  DateTime?
  status       String           @default("DRAFT")
  attachments  String?
  authorId     String
  schoolId     String
  classroomId  String?
  priority     String?          @default("NORMAL")
  requiresAck  Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  classroom    Classroom?       @relation(fields: [classroomId], references: [id])
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  author       User             @relation("DiaryAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  recipients   DiaryRecipient[]

  @@index([schoolId])
  @@index([classroomId])
  @@index([authorId])
  @@index([scheduledFor])
  @@index([status])
}

model DiaryRecipient {
  id             String     @id @default(cuid())
  entryId        String
  recipientType  String
  studentId      String?
  isRead         Boolean    @default(false)
  readAt         DateTime?
  isAcknowledged Boolean    @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  createdAt      DateTime   @default(now())
  student        Student?   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  entry          DiaryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([studentId])
  @@index([isRead])
}

model Role {
  id            String        @id @default(cuid())
  name          String
  description   String?
  permissions   String        @default("[]")
  isSystem      Boolean       @default(false)
  schoolId      String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  leavePolicies LeavePolicy[]
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  users         User[]

  @@unique([schoolId, name])
}

model ClassAccess {
  id          String    @id @default(cuid())
  userId      String
  classroomId String
  canRead     Boolean   @default(true)
  canWrite    Boolean   @default(false)
  canEdit     Boolean   @default(false)
  canDelete   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, classroomId])
}

model StaffAccess {
  id        String   @id @default(cuid())
  managerId String
  staffId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staff     User     @relation("StaffMapping", fields: [staffId], references: [id], onDelete: Cascade)
  manager   User     @relation("ManagerMapping", fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([managerId, staffId])
}

model Payroll {
  id            String    @id @default(cuid())
  month         Int       // 1-12
  year          Int
  schoolId      String
  status        String    @default("DRAFT") // DRAFT, PROCESSED, PAID
  generatedAt   DateTime  @default(now())
  processedAt   DateTime?
  totalAmount   Float     @default(0)
  school        School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payslips      Payslip[]

  @@unique([schoolId, month, year])
}

model Payslip {
  id              String   @id @default(cuid())
  payrollId       String
  userId          String
  
  // Earnings
  basic           Float    @default(0)
  hra             Float    @default(0)
  allowances      Float    @default(0) 
  bonus           Float    @default(0)
  
  // Deductions
  tax             Float    @default(0)
  pf              Float    @default(0) 
  insurance       Float    @default(0)
  leaveDeduction  Float    @default(0)
  otherDeductions Float    @default(0) 
  customAdditions String?   // JSON Array of {label, amount}
  customDeductions String?  // JSON Array of {label, amount}
  
  // Summary
  grossSalary     Float    @default(0)
  netSalary       Float    @default(0)
  
  // Context
  totalDays       Int      @default(0)
  presentDays     Float    @default(0)
  absentDays      Float    @default(0)
  leaveDays       Float    @default(0)
  
  month           Int
  year            Int
  status          String   @default("UNPAID") // UNPAID, PAID
  paidAt          DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  payroll         Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
}

model PayrollSettings {
  id                  String   @id @default(cuid())
  schoolId           String   @unique
  
  // Automated Incentives
  fullAttendanceBonus Float    @default(0)
  punctualityBonus    Float    @default(0)
  
  // Late Coming Rules
  lateThreshold       Int      @default(3)      // Days allowed late
  latePenalty         Float    @default(0)      // Deduction per late day after threshold
  
  // Overtime / Extras
  overtimeRate        Float    @default(0)      // Per hour
  
  // Work Rules
  workDaysPerWeek     Int      @default(6)
  standardWorkHours   Float    @default(8)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  school              School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
}

model BiometricLog {
  id           String   @id @default(cuid())
  deviceId     String
  deviceUserId String
  timestamp    DateTime
  status       Int      // 0=CheckIn, 1=CheckOut, 255=Unspecified
  verifyMode   Int?     // 1=Finger, 15=Face, etc.
  processed    Boolean  @default(false)
  raw          String?  // Store full raw string if needed
  schoolId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([deviceId, deviceUserId, timestamp])
  @@index([schoolId])
  @@index([schoolId, timestamp])
}

model LibraryBook {
  id          String   @id @default(cuid())
  title       String
  author      String
  isbn        String?
  publisher   String?
  category    String?
  coverUrl    String?
  copies      Int      @default(1)
  shelfNo     String?
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  transactions LibraryTransaction[]

  @@index([schoolId])
  @@index([title])
  @@index([isbn])
}

// --- Transport Module ---

model TransportVehicle {
  id                String   @id @default(cuid())
  registrationNumber String
  model             String?
  capacity          Int
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  status            String   @default("ACTIVE") // ACTIVE, MAINTENANCE, INACTIVE
  gpsDeviceId       String?  // For future integration
  
  // Compliance Documents
  insuranceNumber   String?
  insuranceExpiry   DateTime?
  insuranceDocUrl   String?
  
  pollutionNumber   String?
  pollutionExpiry   DateTime?
  pollutionDocUrl   String?
  
  fitnessExpiry     DateTime?
  fitnessDocUrl     String?
  
  permitNumber      String?
  permitExpiry      DateTime?
  permitDocUrl      String?
  
  rcDocUrl          String?

  routes            TransportRoute[]
  maintenanceLogs   TransportMaintenance[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([schoolId, registrationNumber])
  @@index([schoolId])
}

model TransportDriver {
  id              String   @id @default(cuid())
  name            String
  licenseNumber   String
  phone           String
  schoolId        String
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  status          String   @default("ACTIVE") // ACTIVE, ON_LEAVE, INACTIVE
  
  // Optional link to Staff if driver is an employee
  userId          String?  @unique
  user            User?    @relation(fields: [userId], references: [id])

  routes          TransportRoute[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
}

model TransportRoute {
  id          String   @id @default(cuid())
  name        String   // e.g., "Route 1 - North City"
  description String?
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  vehicleId   String?
  vehicle     TransportVehicle? @relation(fields: [vehicleId], references: [id])
  
  driverId    String?
  driver      TransportDriver? @relation(fields: [driverId], references: [id])

  stops       TransportStop[]
  students    StudentTransportProfile[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([schoolId])
}

model TransportStop {
  id            String   @id @default(cuid())
  name          String
  routeId       String
  route         TransportRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  
  sequenceOrder Int      // 1, 2, 3...
  latitude      Float?
  longitude     Float?
  pickupTime    String?  // "07:30 AM"
  dropTime      String?  // "03:30 PM"
  
  pickupStudents StudentTransportProfile[] @relation("PickupStop")
  dropStudents   StudentTransportProfile[] @relation("DropStop")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([routeId])
}

model StudentTransportProfile {
  id            String   @id @default(cuid())
  studentId     String   @unique
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  routeId       String
  route         TransportRoute @relation(fields: [routeId], references: [id])
  
  pickupStopId  String?
  pickupStop    TransportStop? @relation("PickupStop", fields: [pickupStopId], references: [id])
  
  dropStopId    String?
  dropStop      TransportStop? @relation("DropStop", fields: [dropStopId], references: [id])
  
  transportFee  Float    @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([routeId])
}

model TransportMaintenance {
  id          String   @id @default(cuid())
  vehicleId   String
  vehicle     TransportVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  type        String   // SERVICE, REPAIR, FUEL, OTHER
  cost        Float
  date        DateTime
  description String?
  fileUrl     String?  // Invoice/Bill
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([vehicleId])
}

model LibraryTransaction {
  id          String   @id @default(cuid())
  bookId      String
  book        LibraryBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  
  // Polymorphic-like relationship
  studentId   String?
  student     Student? @relation(fields: [studentId], references: [id])
  staffId     String?
  staff       User?    @relation(fields: [staffId], references: [id])
  
  issuedDate  DateTime @default(now())
  dueDate     DateTime
  returnedDate DateTime?
  status      String   @default("ISSUED") // ISSUED, RETURNED, OVERDUE, LOST
  fineAmount  Float    @default(0)
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([bookId])
  @@index([studentId])
  @@index([staffId])
  @@index([status])
}

model LibrarySettings {
  id          String   @id @default(cuid())
  schoolId    String   @unique
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  maxBooksStudent Int @default(2)
  maxBooksStaff   Int @default(5)
  maxDaysStudent  Int @default(7)
  maxDaysStaff    Int @default(14)
  finePerDay      Float @default(10)
}

model Exam {
  id            String   @id @default(cuid())
  title         String
  description   String?
  date          DateTime
  type          String   @default("TERM") // TERM, TEST, ETC
  category      String   @default("ACADEMIC") // ACADEMIC, SPORTS, ARTS, CO_CURRICULAR
  classrooms    String   @default("[]") // JSON Array of classroom IDs
  subjects      String   @default("[]") // JSON Array of subject names
  maxMarks      Float    @default(100)
  minMarks      Float    @default(0)
  questionPaperUrl String?
  gradingSystem String   @default("MARKS") // MARKS, GRADES
  schoolId      String
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  results       ExamResult[]
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy     User     @relation(fields: [createdById], references: [id])

  @@index([schoolId])
}

model ExamResult {
  id        String   @id @default(cuid())
  marks     Float?
  grade     String?
  status    String? // PASSED, FAILED
  remarks   String?
  subject   String? 
  examId    String
  studentId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([examId, studentId, subject])
  @@index([studentId])
}

model StudentHealthRecord {
  id             String   @id @default(cuid())
  height         Float?
  weight         Float?
  bmi            Float?
  visionLeft     String?
  visionRight    String?
  hearingLeft    String?
  hearingRight   String?
  dentalStatus   String?
  generalHealth  String?
  bloodPressure  String?
  pulseRate      Int?
  recordedAt     DateTime @default(now())
  recordedById   String?
  studentId      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  student        Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  recordedBy     User?    @relation(fields: [recordedById], references: [id])

  @@index([studentId])
}

model StudentActivityRecord {
  id          String   @id @default(cuid())
  title       String
  category    String // SPORTS, ARTS, CLUB, ETC
  type        String // PARTICIPATION, AWARD
  date        DateTime
  description String?
  achievement String? // "First Place", "Gold Medal"
  studentId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}

// CMS & Marketing
model CMSPage {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  isPublished Boolean  @default(false)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  coverImage  String?
  authorId    String
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  tags        String   @default("[]")

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id])
}

model JobPosting {
  id          String   @id @default(cuid())
  title       String
  department  String
  location    String
  type        String
  description String
  requirements String?
  isOpen      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications JobApplication[]
}

model JobApplication {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String
  phone       String
  resumeUrl   String?
  coverLetter String?
  linkedin    String?
  portfolio   String?
  status      String   @default("PENDING") // PENDING, REVIEWING, INTERVIEW, OFFER, REJECTED
  
  jobId       String
  job         JobPosting @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([jobId])
  @@index([email])
}

// Homepage CMS
model HomepageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "features", "pricing", "cta"
  title       String?
  subtitle    String?
  content     String   // JSON string for flexible content
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Features Page CMS
model FeaturesPageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "highlight", "features"
  title       String?
  subtitle    String?
  content     String   // JSON string for flexible content
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Pricing Page CMS
model PricingPageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "faq"
  title       String?
  subtitle    String?
  content     String   // JSON string
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Careers Page CMS
model CareersPageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "values"
  title       String?
  subtitle    String?
  content     String   // JSON string
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Contact Page CMS
model ContactPageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "info"
  title       String?
  subtitle    String?
  content     String   // JSON string
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Blog Page CMS (Settings/Layout)
model BlogPageContent {
  id          String   @id @default(cuid())
  sectionKey  String   @unique // e.g., "hero", "sidebar"
  title       String?
  subtitle    String?
  content     String   // JSON string
  isEnabled   Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
